---
title: "Data Wrangling & Reproducible Research"
author: "Dale W. Steele, MD, MS"
date: "12 November, 2025"
format: 
  revealjs:
    theme: default
    css: custom.scss
    slide-number: true
    transition: fade
    transition-speed: default
    background-transition: fade
    code-line-numbers: false
    highlight-style: github
    code-overflow: wrap
    incremental: false
    smaller: false
    scrollable: true
    preview-links: auto
    footer: "Data Wrangling & Reproducible Research | Dale W. Steele"
    navigation-mode: linear
---

## A Story About **Non**-Reproducible Research {background-color="#1e3a5f"}
![](images/once_upon_a_time.jpg)

## A younger Siraj Amanullah, MD, MPH

::: {.r-stack}
![](images/young_siraj.jpg){width="70%"}
:::

## The Analysis ... {.smaller}

::: {.incremental}
-   Phone call from my brilliant, sometimes frenetic friend and colleague about a project related to disparities in our care
-   "Can you help me with a regression analysis?"
-   Met for lunch with two laptops, a USB stick and a large order of bread sticks
-   I spent a few pleasant hours that evening noodling with R
-   Later implemented using SAS by my friend
:::

## Months later... {auto-animate="true"}

::: {.incremental}
-   Manuscript submitted to a high impact journal
-   Rejected by editor! ðŸ˜ž
-   Submitted to a somewhat lower impact journal
-   Rejected!! ðŸ˜©
:::

## Even more months later... {auto-animate="true"}

::: {.incremental .highlight-last}
-   After 53 emails, reams of SAS output
-   Submitted to yet another journal
:::

## Still later... {.smaller}

::: {.fragment .fade-in}
-   Revise and reconsider!!!
:::

::: {.fragment .highlight-red}
-   "I **think** the most recent one is `laceartion.manuscript.reveision.WJEM.march2105inclyuding acuity model.docx`"
:::

::: {.fragment .grow}
-   **"Can you just edit the methods and results section?"**
-   **"Do you remember why we didn't include *covariate X6* in the model?"**
:::

::: {.fragment}
-   "They want the revised manuscript next week"
:::

## {background-image="images/siraj_disparities.png" background-size="contain"}

## What is reproducible research? {.smaller}

::: {.callout-important icon="false"}
## The Goal
Given the raw data and code, someone else (or **future you**) can reproduce your analysis
:::

::: {.incremental}
-   The **code** used to **clean and analyse the data**
-   The **code** used to generate **results**, **figures**, and **tables**
-   **Text** describing methods and interpreting results
-   The software environment you used
-   The *hardware* you ran it on
:::

## Tools for Analysis

::: {.r-stack}
![](images/stats_programs_meme.jpg){width="80%"}
:::

## Graphical User Interface: Stata

![](images/stata_gui.png){width="100%"}

## Beware!! {background-color="#8b0000"}

::: {.r-stack}
![](images/Cut-copy-and-paste-images.jpg){width="70%"}
:::

## Why Geeks Love Plain Text {.smaller}
### (and why you should too)

::: {layout="[[1], [1]]"}
![](images/txt.png)

[The Elegance of Plain-Text Writing](https://unvarnishedgeek.github.io/2020/11/25/plain-text-one.html){preview-link="true"}
:::

## Stata: Do-file Editor

![](images/stata_do_editor.png)

## File Names {background-color="#2d2d2d"}

::: {.r-stack}
![](images/file_naming_conventions.png){width="90%"}
:::

## File Naming Conventions {.smaller}

::: {.callout-tip}
## Best Practices
Use consistent file names that are:

-   Machine readable **AND** human readable
-   Play well with default ordering
-   Regular expression and globbing friendly
-   Avoid spaces, punctuation, accented characters, case sensitivity
:::

## File Naming continued... {.smaller}

::: {.callout-note}
## Conventions

-   Use "`-`" to delimit words and "`_`" to delimit sections
-   `YYYY-MM-DD` for dates, e.g., `2019-01-19_my-data.csv`
-   Left-pad numbers: `01_my-data.csv` versus `1_my-data.csv`
:::

::: {.aside}
Resources: [Jenny Bryan's Guide](https://speakerdeck.com/jennybc/how-to-name-files) | [HMS Data Management](https://datamanagement.hms.harvard.edu/plan-design/file-naming-conventions)
:::

## {background-image="images/cluttered_desktop_meme.jpg" background-size="contain"}

## Consistent and Informative Directory Structure

::: {.r-stack}
![](images/directory-structure.png){width="75%"}
:::

## RStudio: An IDE for R {.smaller}

::: {.callout-tip icon="false"}
## Integrated Development Environment
All your tools in one place
:::

![](images/rstudio.png)

## RStudio Project Directory Structure

::: {layout="[1,1]"}
![](images/folder-structure.png)

::: {.callout-warning}
## The Golden Rule
*Raw data should never be changed!*

Save raw data to "data" folder and treat it as immutable
:::
:::

## Other Goals for a Reproducible Project {.smaller}

::: {.columns}
::: {.column width="50%"}
### DRY Principle
**D**on't **R**epeat **Y**ourself

-   Minimize duplication of code and data
:::

::: {.column width="50%"}
### Project Standards

-   Self-contained
-   README file(s)
:::
:::

::: {.aside}
[EcoRepSci Guide](https://ecorepsci.github.io/reproducible-science/project-organization.html#golden-rules)
:::

## Version Control: Github repository {.smaller}

::: {.callout-tip}
## This Presentation
Track every change, collaborate effectively
:::

![](images/github_cete.png)

## Spreadsheet Hell: Formatting Issues {background-color="#5d001e"}

![](images/spreadsheet_errors.png)

## Spreadsheet Hell: Multiple Tables {background-color="#5d001e"}

![](images/multiple_tables.jpg)

## Escape from Spreadsheet Hell {.smaller}

::: {.columns}
::: {.column width="50%"}
### Structure
-   One sheet, one "data set"
-   One value per cell
-   No merged cells
-   No blank rows/columns as separators
:::

::: {.column width="50%"}
### Formatting
-   Decorative formatting only for navigation
-   First row for headers only
-   Header names without spaces
:::
:::

::: {.aside}
[Iowa State LibGuide](https://instr.iastate.libguides.com/spreadsheets/setup)
:::

## Preparing Data - Tidy Data {.smaller}

::: {.callout-important icon="false"}
## Three Rules

-   Each variable forms a column
-   Each observation forms a row
-   Each type of observational unit forms a table
:::

![](images/tidy-data.png)

::: {.aside}
[R for Data Science: Tidy Data](https://r4ds.had.co.nz/tidy-data.html)
:::

## Google sheets {.smaller}
### Parse sheet with R!

![](images/gsheet.png){width="70%"}

```{r}
#| echo: true
#| eval: false
#| code-line-numbers: "1|3-4"
library(googlesheets4)

evmap <- read_sheet(link, sheet = "OCD_evidence_map", col_types = 'c') |>
  clean_names()
```

## When a Spreadsheet Isn't Enough {.smaller}

::: {.columns}
::: {.column width="50%"}
### Databases
![REDCap](images/redcap.png)
:::

::: {.column width="50%"}
### Application Programming Interface (API)

```{r}
#| echo: true
#| eval: false
ds <- redcap_read(
  redcap_uri = uri, 
  token = token
)$data 
```
:::
:::

## Literate Programming {.smaller}

::: {.callout-note icon="false"}
## Markdown

A plain text format designed to be easy to write and read
:::

::: {.incremental}
-   May contain code chunks (`R`, `Python`, `Julia`, etc.)
-   "Knitted" or "rendered" to produce multiple formats
-   Outputs: PDF, web pages, HTML slides, **even** MS Word or PowerPoint
:::

## My 2011 Master's Thesis

::: {.columns}
::: {.column width="60%"}
![Written in GNU emacs](images/emacs_ess_Rnw.png)
:::

::: {.column width="40%"}
### Still Popular!

![](images/uri_thesis.jpg)

[View Thesis](https://digitalcommons.uri.edu/theses/107/)
:::
:::

## CODE to Make Plots {.smaller}
### ggplot in R, part of the "tidyverse"

```{r}
#| echo: true
#| output-location: slide
#| code-line-numbers: "|3|4-6"
library(ggplot2)

mtcars |> 
  ggplot(aes(x = disp, y = mpg)) +
  geom_point() +
  geom_smooth(method = "loess", formula = "y~x")
```

## Code to Make Tables {.smaller}
### Flextable: Table Generation in R

```{r}
#| echo: true
#| output-location: slide
#| code-line-numbers: "|2|3-4|5|6-7"
library(flextable)
ft <- flextable(airquality[sample.int(10),]) |> 
  add_header_row(colwidths = c(4, 2), 
                 values = c("Air quality", "Time")) |>          
  theme_vanilla() |> 
  add_footer_lines("Daily air quality measurements in NYC, May to Sept 1973.") |>
  color(part = "footer", color = "#666666")

ft
```

## Challenges {.smaller}

::: {.columns}
::: {.column width="50%"}
### Technical
-   Security and confidentiality
-   Tools evolve constantly
-   Complexity requires expertise
-   Multiple software tools
:::

::: {.column width="50%"}
### Practical
-   Computer-intensive pipelines
-   Collaboration difficulties
-   Learning curve
:::
:::

## Reproducible AI or AI for Reproducibility {background-color="#1e3a5f"}

::: {.r-stack}
![](images/ai_cures_all.jpg){width="60%"}
:::

::: {.fragment}
[Is AI leading to a reproducibility crisis in science?](https://www.nature.com/articles/d41586-023-03817-6){target="_blank"}
:::

## Documenting AI Use in Your Workflow {.smaller}

```{r}
#| echo: true
#| eval: false
#| code-line-numbers: "1-10|12-18|20-23|25-32|34"
# Good practice: Document AI assistance
# File: analysis.R
# Created: 2025-01-10
# AI Tools Used: 
#   - GitHub Copilot for regex pattern in lines 45-52
#   - ChatGPT-4 for initial dplyr chain (modified in lines 78-95)
# Last validated: 2025-01-10

library(tidyverse)

# AI-generated regex (verified against test cases)
# Original prompt: "regex to extract ICD-10 codes from clinical notes"
extract_icd10 <- function(text) {
  str_extract_all(text, "\\b[A-TV-Z][0-9]{2}\\.?[0-9A-TV-Z]{0,4}\\b")
}

# Test cases to verify AI code
test_cases <- tibble(
  input = c("Patient has E11.9 diabetes", 
            "Diagnosis: J18.9, I10",
            "No codes here"),
  expected = list(c("E11.9"), c("J18.9", "I10"), character(0))
)

test_cases <- test_cases %>%
  mutate(
    actual = map(input, extract_icd10),
    passed = map2_lgl(expected, actual, identical)
  )

stopifnot(all(test_cases$passed))  # Halt if AI code fails tests
```

## Computational Non-Determinism {.smaller}
### **Hardware matters now.**

::: {.callout-warning}
## Document your computing environment!
:::

```{r}
#| echo: true
#| eval: false
#| code-line-numbers: "1-2|4-6|8-15|17-26|28-29"
# Even with set.seed(), some operations aren't reproducible
library(keras)  # Python-based deep learning

set.seed(123)  # This won't be enough!

# Problem: GPU parallelism introduces randomness
model <- keras_model_sequential() %>%
  layer_dense(units = 64, activation = "relu") %>%
  layer_dense(units = 1)

# Run 1: loss = 0.234
# Run 2: loss = 0.237  # Different! Even with same seed

# Better approach: Document everything
sessionInfo()  # R version, packages
reticulate::py_config()  # Python environment
# GPU model: NVIDIA RTX 3080
# CUDA version: 11.8
# Random seed: 123
# Date/time: 2025-01-10 14:30 EST

# For critical work: use CPU-only mode for reproducibility
tensorflow::tf$config$set_visible_devices(list(), 'GPU')
```

## Online Resources {.smaller}

::: {.columns}
::: {.column width="50%"}
-   [Health Data Science in R](https://alicepaul.github.io/health-data-science-using-r/){target="_blank"}

-   [R for Data Science (2e)](https://r4ds.hadley.nz/){target="_blank"}

-   [Data Wrangling with R](https://stat545.com/){target="_blank"}
:::

::: {.column width="50%"}
-   [Modern Data Science with R](https://mdsr-book.github.io/mdsr3e/){target="_blank"}

-   [Happy Git and GitHub for useR](https://happygitwithr.com/){target="_blank"}

-   [Building Reproducible Pipelines](https://raps-with-r.dev/){target="_blank"}
:::
:::

## Thank You! {background-color="#1e3a5f"}

::: {.r-stack}
### Questions?

Dale W. Steele, MD, MS

Brown University
:::
